<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crear Producto</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
    <script src="js/nav.js"></script>
    <link rel="stylesheet" href="css/style.css">
    <script>
        // Llama a la función para cargar la navbar una vez que el DOM esté completamente cargado
        document.addEventListener('DOMContentLoaded', loadNavbar);
    </script>
</head>
<div id="navbar"></div>

<body>
    <div class="container mt-5">
        <h2>Creación de Producto</h2>
        <div id="productDetails"></div>
        <div id="availabilityMessage"></div>
        <button class="btn btn-success" id="createButton" disabled>Crear</button>
    </div>

    <script>
        const product = JSON.parse(localStorage.getItem('selectedProduct'));
        const rawMaterials = JSON.parse(localStorage.getItem('rawMaterials')) || [];

        document.getElementById('productDetails').innerHTML = `
      <h3>${product.name}</h3>
      <ul>
        ${product.ingredients.map(ingredient => `<li>${ingredient.name} - Cantidad: ${ingredient.quantity}</li>`).join('')}
      </ul>
    `;

        function checkMaterialsAvailability() {
            let sufficientMaterials = true;
            let message = '';

            product.ingredients.forEach(ingredient => {
                const material = rawMaterials.find(mat => mat.nombre === ingredient.name);
                if (!material || material.cantidad < ingredient.quantity) {
                    sufficientMaterials = false;
                    const missingAmount = material ? ingredient.quantity - material.cantidad : ingredient.quantity;
                    message += `Falta ${missingAmount} de ${ingredient.name}<br>`;
                }
            });

            if (sufficientMaterials) {
                document.getElementById('availabilityMessage').innerHTML = '<div class="alert alert-success">Suficiente materia prima disponible</div>';
                document.getElementById('createButton').disabled = false;
            } else {
                document.getElementById('availabilityMessage').innerHTML = `<div class="alert alert-danger">${message}</div>`;
                document.getElementById('createButton').disabled = true;
            }
        }

        document.getElementById('createButton').addEventListener('click', () => {
            product.ingredients.forEach(ingredient => {
                const material = rawMaterials.find(mat => mat.nombre === ingredient.name);
                material.cantidad -= ingredient.quantity; // Descuenta la cantidad
            });
            localStorage.setItem('rawMaterials', JSON.stringify(rawMaterials));

            // Redirigir a la página de producción
            const productsInProduction = JSON.parse(localStorage.getItem('productsInProduction')) || [];
            productsInProduction.push(product);
            localStorage.setItem('productsInProduction', JSON.stringify(productsInProduction));
            window.location.href = 'produccion.html';
        });

        // Verificar la disponibilidad al cargar la página
        checkMaterialsAvailability();
    </script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>